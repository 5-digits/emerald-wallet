language: node_js
node_js: 6
os:
  - osx
  - linux
env:
  # Note: CCX vs. CXX? WTF FTW.
  # This is obviously not ideal. I never was good with linear algebra. Damn matrixes.
  - CCX=gcc-4.8 FULL_CHECK=false # osx
  - CCX=gcc-4.8 FULL_CHECK=true # osx
  - CXX=g++-4.8 FULL_CHECK=false # linux
  - CXX=g++-4.8 FULL_CHECK=true # linux
cache:
  directories:
    - "node_modules"
matrix:
  # Don't build for incompatible c compilers.
  exclude:
    - os: osx
      env: CXX=g++-4.8 FULL_CHECK=false
    - os: osx
      env: CXX=g++-4.8 FULL_CHECK=true
    - os: linux
      env: CCX=gcc-4.8 FULL_CHECK=false
    - os: linux
      env: CCX=gcc-4.8 FULL_CHECK=true
  allow_failures:
    - os: osx
      env: CXX=gcc-4.8 FULL_CHECK=true
    - os: linux
      env: CXX=g++-4.8 FULL_CHECK=true
# before_install:
before_script:
  # `npm install` is automatic
  - npm install node-gyp -g
  - npm install -g license-checker
  # Install cargo and cargo install emerald and move to project base.
  - bash ./dependencies.sh
script:
  # Generate current version information from git tags.
  # - git describe --tags --always > version.txt
  # - sed -E 's/v([[:digit:]]+\.[[:digit:]]+)\.[[:digit:]]-([[:digit:]]+)-g([a-f0-9]+)/v\1.\2+\3/' version.txt > version-app.txt
  # - sed -E 's/v([[:digit:]]+\.[[:digit:]]+)\.[[:digit:]]-([[:digit:]]+).+/v\1.\2/' version.txt > version-only.txt
  # - sed -E 's/v([[:digit:]]+\.[[:digit:]]+)\.[[:digit:]]-([[:digit:]]+).+/v\1.x/' version.txt > version-base.txt
  - if [[ $(license-checker --production --exclude '(GPL-2.0 OR MIT)' | grep GPL) ]]; then license-checker --production | grep -C 1 GPL && false; fi
  - npm run build
  - if [[ $FULL_CHECK == "true" ]]; then npm run lint --silent; fi
  # Don't sign the build for now.
  - env CSC_IDENTITY_AUTO_DISCOVERY=false npm run dist
  - ls -l ./dist/
  # Set up bintray deploy config.
  # - sed -E "s/APPVERSION/$(cat version-base.txt)/" bintray.tpl.json > bintray.json
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    # - gcc-multilib
    # - g++-multilib
    # - gcc-4.8-multilib
    # - g++-4.8-multilib
    # - ia32-libs
    # - libc6-dev #predefs
deploy:
  provider: bintray
  file: "bintray.json"
  user: splix
  key:
    secure: "OQFcHH2k8ixSPhZAlq8C4/+oABVkpKjdE93Ye60pmFJuYdU7KyiyC594ZXEeIzMlaTLt8D8eXGMCEbaR3/w9URERdfNu5NG73sZVGYo3d7Y5F7Aam+rmZIYrAQnfUc1udILKPh/5zDJ4x3RXJXPwJeXPXdnEV4sV4dMj6Ol6sQETZXaDIsjKdMqtk2Kg/VNpgkBdqjrxMQb2QQAtVLdZ1kGJcaK5UvxdvD0I6c671q2L13tmpQNglmkDBQHgoO97/Mm5UT0ttCJe2JGVlcWWziXV0Jvt22jKBb2MoQGA2NibwGFMry+R0cASLROV9F+r9tE0aqCM62oFkDh8NODL63rW6KBOiRCCfayGT+GREDV64SHTXF5MqAaSKQjQlqhA3plQqaBw7EhXCdR++1a8Zkca7YbmVbSJf5nKA1kJ98N2kdARat0OaSYxcnszPR08NuO6CH29NTJ0AVLhRH+V/pTckXnzep8lqN7UNQwCpIC+f2aImXNYXedVmr7OxCDdTEY5tekJnPEgPIZuSmj/QiMrDjD96qCtFSEPfVzQp3Ix9AnqRDZzh5vSxCxlPAvpRg7wEOVYC9WWlsMIYVozCiMPXXRqrb+4OtK3sHEJXBJmmu/3N1Z5SdQYHp0R9wCTjqIciWx+j98iyFH5GcDRtxHqvqAuyTwjVg14rInuuhk="
  on:
    branch: builder
  tags: true
